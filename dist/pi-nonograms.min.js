/*
jsrand v1.0
https://github.com/DomenicoDeFelice/jsrand
@license
*/
if(!window.dfd){window.dfd={}}dfd.Srand=Srand=function(n){var e=function(n){if(n!==undefined){this.seed(n)}else{this.randomize()}};e._oldSrand=n;return e}(window.Srand);Srand.prototype={};Srand.seed=Srand.prototype.seed=function(n){if(n===undefined){return this._seed}this._mz=123456789;return this._mw=this._seed=n};Srand.randomize=Srand.prototype.randomize=function(){var n=this.randomIntegerIn(1,4294967295,Math.random());this.seed(n);return n};Srand.random=Srand.prototype.random=function(){if(this._seed===undefined){this.randomize()}var n=this._mz;var e=this._mw;n=(n&65535)*36969+(n>>16)&4294967295;e=(e&65535)*18e3+(e>>16)&4294967295;this._mz=n;this._mw=e;var t=((n<<16)+e&4294967295)/4294967296;return.5+t};Srand.randomIn=Srand.prototype.randomIn=function(n,e,t){if(t===undefined){t=this.random()}return n+t*(e-n)};Srand.randomIntegerIn=Srand.prototype.randomIntegerIn=function(n,e,t){if(t===undefined){t=this.random()}return n+Math.floor(t*(e-n+1))};Srand.noConflict=function(){Srand=dfd.Srand._oldSrand;return dfd.Srand};
/*
  A nonogram game written in javascript
  https://github.com/DomenicoDeFelice/Pi-Nonograms

  Play the game: http://freenonograms.altervista.org

  Copyright (c) 2013-2015 Domenico De Felice

  @license

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
!function(n){if(!n.dfd){n.dfd={}}dfd.Event=function(n){this._sender=n;this._listeners=[]};dfd.Event.prototype.attach=function n(e){this._listeners.push(e)};dfd.Event.prototype.notify=function n(e){for(var t=0,o=this._listeners.length;t<o;t++){this._listeners[t](this._sender,e)}}}(window);!function(n){if(!n.dfd){n.dfd={}}if(!dfd.nonograms){dfd.nonograms={}}dfd.nonograms.CellState={UNKNOWN:"unknown",FILLED:"filled",EMPTY:"empty"};dfd.nonograms.GameMode={PLAY:"play",DRAW:"draw"}}(window);!function(n){if(!n.dfd){n.dfd={}}if(!dfd.nonograms){dfd.nonograms={}}dfd.nonograms.DragHelper=function(){this._dragging=false};dfd.nonograms.DragHelper.prototype={start:function(n,e,t){this._x1=this._x2=n;this._y1=this._y2=e;this._guess=t;this._dragging=true},to:function(n,e){this._x2=n;this._y2=e},stop:function(){this._dragging=false},isDragging:function(){return this._dragging},iterateOverDraggedCells:function(n){var e=this._x1;var t=this._y1;var o=this._x2;var i=this._y2;var s,r,d,a,h,f;if(Math.abs(e-o)>Math.abs(t-i)){d=1;f=0;a=h=t;if(e<o){s=e;r=o}else{s=o;r=e}}else{d=0;f=1;s=r=e;if(t<i){a=t;h=i}else{a=i;h=t}}for(var l=s,u=a;l<=r&&u<=h;l+=d,u+=f){n(l,u,this._guess)}}}}(window);!function(n){if(!n.dfd){n.dfd={}}if(!dfd.nonograms){dfd.nonograms={}}dfd.nonograms.Model=function(n){if(!n)n={};this.width=n.width;this.height=n.height;this._srand=n.srand;this.events={};this.events.guessChanged=new dfd.Event(this);this.events.nonogramChanged=new dfd.Event(this);this.events.nonogramSolved=new dfd.Event(this);this.events.nonogramUnsolved=new dfd.Event(this);this._setupNonogram();this.setMode(n.mode)};dfd.nonograms.Model.prototype={_indexFromXY:function(n,e){return e*this.width+n},_XYFromIndex:function(n){var e=this.width;var t=Math.floor(n/e);var o=n%e;return[o,t]},getCellAt:function(n,e){var t=dfd.nonograms.CellState;var o;if(e===undefined){o=n}else{o=this._indexFromXY(n,e)}var i=this._actual[o];return i===undefined?t.EMPTY:i},getGuessAt:function(n,e){var t=dfd.nonograms.CellState;var o;if(e===undefined){o=n}else{o=this._indexFromXY(n,e)}var i=this._guess[o];return i===undefined?t.UNKNOWN:i},setGuessAt:function(n,e,t){var o;if(t===undefined){t=e;o=n}else{o=this._indexFromXY(n,e)}var i=this.getGuessAt(o);this._guess[o]=t;this.events.guessChanged.notify({x:n,y:e,oldGuess:i,newGuess:t});var s=dfd.nonograms.GameMode;if(this._mode===s.PLAY)this._checkIfSolved()},getMode:function(){return this._mode},setMode:function(n){var e=dfd.nonograms.GameMode;if(n===this._mode)return;this._mode=n;if(n===e.DRAW){this._guess=this._actual}else{var t=this.width*this.height;this._guess=new Array(t)}this._setUnsolved();this.events.nonogramChanged.notify()},isSolved:function(){return this._solved},getRowDefinition:function(e){var t=this;return this._getLineDefinition(this.width,function(n){return t.getCellAt(n,e)},function(n){return t.getGuessAt(n,e)},function(n){return n===0||n===t.width-1})},getColumnDefinition:function(e){var t=this;return this._getLineDefinition(this.height,function(n){return t.getCellAt(e,n)},function(n){return t.getGuessAt(e,n)},function(n){return n===0||n===t.height-1})},_getLineDefinition:function(n,e,t,o){var i=dfd.nonograms.CellState;var s=dfd.nonograms.GameMode;var r=[];var d;var a;var h;var f=0;var l=this._mode;for(var u=0;u<n;u++){if(e(u)===i.FILLED){if(f===0)d=u;f++}else if(f){a=u-1;h=false;if(l===s.PLAY){if((o(d)||t(d-1)===i.EMPTY)&&(o(a)||t(a+1)===i.EMPTY)){h=true;for(var g=d;g<=a;g++){if(t(g)!==i.FILLED){h=false;break}}}}r.push({length:f,solved:h});f=0}}if(f){a=u-1;h=false;if(l===s.PLAY){if((o(d)||t(d-1)===i.EMPTY)&&(o(a)||t(a+1)===i.EMPTY)){h=true;for(var g=d;g<=a;g++){if(t(g)!==i.FILLED){h=false;break}}}}r.push({length:f,solved:h})}return r},giveHint:function(){var n=dfd.nonograms.CellState;var e=dfd.nonograms.GameMode;if(this.isSolved()||this._mode!==e.PLAY)return;var t=this.width*this.height;var o=this._actual;var i=this._guess;var s,r,d;for(var a=t;a--;){if(i[a]===n.FILLED&&o[a]!==n.FILLED||i[a]===n.EMPTY&&o[a]===n.FILLED){s=this._XYFromIndex(a);r=s[0];d=s[1];this.setGuessAt(r,d,this.getCellAt(r,d));return}}do{s=this._getRandomXY();r=s[0];d=s[1]}while(this.getGuessAt(r,d)!==n.UNKNOWN);this.setGuessAt(r,d,this.getCellAt(r,d))},randomize:function(n){var e=dfd.nonograms.CellState;var t=dfd.nonograms.GameMode;this._setupNonogram();this._mode=t.PLAY;var o=this._actual;var i=this.width*this.height;var s=Math.floor(i*n);if(s>i)s=i;var r;while(s){r=this._getRandomIndex();if(o[r]===undefined){o[r]=e.FILLED;s--}}this.events.nonogramChanged.notify()},resetGuesses:function(){var n=dfd.nonograms.GameMode;var e=this.width*this.height;this._guess=new Array(e);if(this._mode===n.DRAW){this._actual=this._guess}this._solved=false;this.events.nonogramChanged.notify()},_setupNonogram:function(){var n=this.width*this.height;this._actual=new Array(n);this._guess=new Array(n);this._setUnsolved()},_getRandomIndex:function(){var n=this.width*this.height;return this._srand.randomIntegerIn(0,n-1)},_getRandomXY:function(){var n=this._srand.randomIntegerIn(0,this.width-1);var e=this._srand.randomIntegerIn(0,this.height-1);return[n,e]},_setSolved:function(){if(!this.isSolved()){this._solved=true;this.events.nonogramSolved.notify()}},_setUnsolved:function(){if(this.isSolved()){this._solved=false;this.events.nonogramUnsolved.notify()}},_checkIfSolved:function(){var n=dfd.nonograms.CellState;var e=this._actual;var t=this._guess;for(var o=e.length;o--;){if(e[o]===n.FILLED&&t[o]!==n.FILLED||e[o]!==n.FILLED&&t[o]===n.FILLED){this._setUnsolved();return}}this._setSolved()}}}(window);!function(n,r){if(!n.dfd){n.dfd={}}if(!dfd.nonograms){dfd.nonograms={}}dfd.nonograms.View=function(n,e){this._model=n;this._$container=r(e);this._$nonogram=null;this._theme="classic";var t;do{t="nonogram-"+dfd.Srand.randomIntegerIn(0,1e6,Math.random())}while(r("#"+t).length);this._id=t;this.events={};this.events.mouseDownOnCell=new dfd.Event(this);this.events.mouseUp=new dfd.Event(this);this.events.mouseEntersCell=new dfd.Event(this);this.events.mouseLeavesCell=new dfd.Event(this)};dfd.nonograms.View.prototype={show:function(){this.rebuildNonogram()},setSolved:function(){this._$nonogram.removeClass("nonogram_playing").addClass("nonogram_solved")},setUnsolved:function(){this._$nonogram.removeClass("nonogram_solved").addClass("nonogram_playing")},setTheme:function(n){if(this._$nonogram){this._$nonogram.removeClass(this._theme).addClass(n)}this._theme=n},highlightColumn:function(n){this._$container.find(".nonogram_column_"+n+"_cell").addClass("nonogram_hovered_column");this._$container.find("#"+this._idOfColumnDefinition(n)).addClass("nonogram_hovered_column")},unhighlightColumn:function(n){this._$container.find(".nonogram_column_"+n+"_cell").removeClass("nonogram_hovered_column");this._$container.find("#"+this._idOfColumnDefinition(n)).removeClass("nonogram_hovered_column")},setGuessAt:function(n,e,t){var o=r("#"+this._idOfCell(n,e));var i=o.data().guess;o.removeClass("nonogram_correct_guess").removeClass(this._guessToCSSClass(i)).addClass(this._guessToCSSClass(t)).data({guess:t});if(this._model.getCellAt(n,e)===t){o.addClass("nonogram_correct_guess")}r("#"+this._idOfRowDefinition(e)).html(this._rowDefinitionToHTML(this._model.getRowDefinition(e)));r("#"+this._idOfColumnDefinition(n)).html(this._columnDefinitionToHTML(this._model.getColumnDefinition(n)))},rebuildNonogram:function(){var n=this._model.width,e=this._model.height;var t,o,i;var s=this._$nonogram=r("<table>").attr("id",this._id).addClass("nonogram").addClass(this._theme);if(this._model.isSolved()){s.addClass("nonogram_solved")}else{s.addClass("nonogram_playing")}i=r("<tr>").addClass("nonogram_row");r("<td>").addClass("nonogram_top_left_cell").appendTo(i);for(t=0;t<n;t++){if(t&&t%5===0){r("<td>").addClass("nonogram_separation_column").appendTo(i)}r("<td>").attr("id",this._idOfColumnDefinition(t)).addClass("nonogram_definition nonogram_column_definition").html(this._columnDefinitionToHTML(this._model.getColumnDefinition(t))).appendTo(i)}i.appendTo(s);for(o=0;o<e;o++){if(o&&o%5===0){r("<tr>").addClass("nonogram_separation_row").append(r('<td colspan="'+(n+n-1)+'">')).appendTo(s)}i=r("<tr>").addClass("nonogram_row");r("<td>").attr("id",this._idOfRowDefinition(o)).addClass("nonogram_definition nonogram_row_definition").html(this._rowDefinitionToHTML(this._model.getRowDefinition(o))).appendTo(i);for(t=0;t<n;t++){if(t&&t%5===0){r("<td>").addClass("nonogram_separation_column").appendTo(i)}r("<td>").attr("id",this._idOfCell(t,o)).addClass(this._CSSClassesForCell(t,o)).data({x:t,y:o,guess:this._model.getGuessAt(t,o)}).appendTo(i)}i.appendTo(s)}this._setupEventHandlers(s);this._$container.finish().hide().empty().append(s).show()},_setupEventHandlers:function(n){var t=this;n.on("mousedown","td",function(n){if(n.which!==1)return;n.preventDefault();var e=r(n.target).data();t.events.mouseDownOnCell.notify(e)});var e=function(){if(!r.contains(document,n[0])){r(document).unbind("mouseup",e)}else{t.events.mouseUp.notify()}};r(document).on("mouseup",e);n.on("mouseover","td",function(n){n.preventDefault();var e=r(n.target).data();t.events.mouseEntersCell.notify(e)});n.on("mouseout","td",function(n){n.preventDefault();var e=r(n.target).data();t.events.mouseLeavesCell.notify(e)})},_idOfCell:function(n,e){return this._id+"_x_"+n+"_y_"+e},_idOfRowDefinition:function(n){return this._id+"_row_"+n+"_definition"},_idOfColumnDefinition:function(n){return this._id+"_column_"+n+"_definition"},_rowDefinitionToHTML:function(n){var e="<nobr>";var t=n.length;for(var o=0;o<t;o++){if(o)e+="&nbsp;";e+='<span class="nonogram_sequence';if(n[o].solved){e+=" nonogram_solved_sequence"}e+='">'+n[o].length+"</span>"}e+="</nobr>";return e},_columnDefinitionToHTML:function(n){var e="";var t=n.length;for(var o=0;o<t;o++){if(o)e+="<br>";e+='<nobr><span class="nonogram_sequence';if(n[o].solved){e+=" nonogram_solved_sequence"}e+='">'+n[o].length+"</span></nobr>"}return e},_CSSClassesForCell:function(n,e){var t=this._model.getGuessAt(n,e);var o=this._model.getCellAt(n,e);var i=[];i.push("nonogram_cell");i.push("nonogram_column_"+n+"_cell");i.push(this._guessToCSSClass(t));if(t===o){i.push("nonogram_correct_guess")}return i.join(" ")},_guessToCSSClass:function(n){var e=dfd.nonograms.CellState;var t=n;if(n===e.UNKNOWN||n===e.FILLED||n===e.EMPTY){t=n}return"nonogram_"+t+"_cell"}}}(window,jQuery);!function(n){if(!n.dfd){n.dfd={}}if(!dfd.nonograms){dfd.nonograms={}}dfd.nonograms.Controller=function(t,o){this._dragHelper=new dfd.nonograms.DragHelper;this._model=t;this._view=o;var i=this;t.events.nonogramChanged.attach(function(){o.rebuildNonogram()});t.events.guessChanged.attach(function(n,e){o.setGuessAt(e.x,e.y,e.newGuess)});t.events.nonogramSolved.attach(function(){o.setSolved()});t.events.nonogramUnsolved.attach(function(){o.setUnsolved()});o.events.mouseDownOnCell.attach(function(n,e){i._dragHelper.start(e.x,e.y,i._nextGuess(t.getGuessAt(e.x,e.y)));i._previewDragging()});o.events.mouseUp.attach(function(){if(!i._dragHelper.isDragging())return;i._dragHelper.stop();i._cancelDraggingPreview();i._applyDragging()});o.events.mouseEntersCell.attach(function(n,e){n.highlightColumn(e.x);if(!i._dragHelper.isDragging())return;i._cancelDraggingPreview();i._dragHelper.to(e.x,e.y);i._previewDragging()});o.events.mouseLeavesCell.attach(function(n,e){n.unhighlightColumn(e.x)})};dfd.nonograms.Controller.prototype={_nextGuess:function(n){var e=dfd.nonograms.CellState;if(n===e.UNKNOWN){return e.FILLED}else if(n===e.FILLED){return e.EMPTY}return e.UNKNOWN},_previewDragging:function(){var o=this._view;this._dragHelper.iterateOverDraggedCells(function(n,e,t){o.setGuessAt(n,e,t)})},_applyDragging:function(){var o=this._model;this._dragHelper.iterateOverDraggedCells(function(n,e,t){o.setGuessAt(n,e,t)})},_cancelDraggingPreview:function(){var o=this._model;var i=this._view;this._dragHelper.iterateOverDraggedCells(function(n,e,t){i.setGuessAt(n,e,o.getGuessAt(n,e))})}}}(window);!function(n){if(!n.dfd){n.dfd={}}if(!dfd.nonograms){dfd.nonograms={}}dfd.nonograms.Nonogram=function(n,e){var t,o,i;var s=dfd.nonograms.Nonogram.options;e=e||{};for(var r in s){e[r]=e[r]||s[r]}t=new dfd.nonograms.Model({width:e.width,height:e.height,srand:e.srand,mode:e.mode});t.events.nonogramSolved.attach(e.onSolved);o=new dfd.nonograms.View(t,n);o.setTheme(e.theme);i=new dfd.nonograms.Controller(t,o);this._model=t;this._view=o;this._controller=i;this._container=n;this._opts=e};dfd.nonograms.Nonogram.options={width:10,height:10,mode:dfd.nonograms.GameMode.PLAY,theme:"classic",srand:dfd.Srand,onSolved:function(){alert("Congratulations! Nonogram solved!")}};dfd.nonograms.Nonogram.prototype={show:function(){this._view.show()},randomize:function(n){var e=.6;if(n&&n.density){e=n.density}this._model.randomize(e)},giveHint:function(){this._model.giveHint()},startOver:function(){this._model.resetGuesses()},setTheme:function(n){this._opts.theme=n;this._view.setTheme(n)},getMode:function(){return this._model.getMode()},setMode:function(n){this._model.setMode(n)},showGameState:function(){}}}(window);